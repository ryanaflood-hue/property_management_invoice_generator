{% extends "base.html" %}
{% block content %}
<div class="page-header">
  <h1>Invoices</h1>
</div>

<div class="card">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Period</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Paid Date</th>
          <th>File</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr>
          <td>{{ inv.invoice_date }}</td>
          <td>
            {% if inv.customer_id in customers %}
            <strong>{{ customers[inv.customer_id].name }}</strong>
            {% else %}
            <span class="text-muted">Deleted Customer</span>
            {% endif %}
          </td>
          <td>{{ inv.period_label }}</td>
          <td>${{ "%.2f"|format(inv.amount) }}</td>
          <td>
            {% if inv.status == 'Paid' %}
            <span class="badge badge-success"
              style="background-color: #28a745; color: white; padding: 5px 10px; border-radius: 4px;">Paid</span>
            {% else %}
            <span class="badge badge-warning"
              style="background-color: #ffc107; color: black; padding: 5px 10px; border-radius: 4px;">Unpaid</span>
            {% endif %}
          </td>
          <td>
            {% if inv.paid_date %}
            {{ inv.paid_date }}
            {% else %}
            -
            {% endif %}
          </td>
          <td>
            <a href="{{ url_for('download_invoice', invoice_id=inv.id) }}" class="badge badge-blue">
              {{ inv.file_path }}
            </a>
          </td>
          <td>
            <button class="btn btn-sm btn-secondary view-email-btn" data-subject="{{ inv.email_subject }}"
              data-body="{{ inv.email_body }}" onclick="openEmailModal(this)">
              View Email
            </button>

            {% if inv.status == 'Paid' %}
            <form action="{{ url_for('toggle_invoice_status', invoice_id=inv.id) }}" method="post"
              style="display:inline;">
              <button type="submit" class="btn btn-sm btn-outline-secondary" style="margin-left: 5px;">Mark
                Unpaid</button>
            </form>
            {% else %}
            <button class="btn btn-sm btn-outline-secondary" style="margin-left: 5px;" data-id="{{ inv.id }}"
              onclick="openPaidModal(this)">
              Mark Paid
            </button>
            {% endif %}

            <form action="{{ url_for('delete_invoice', invoice_id=inv.id) }}" method="post" style="display:inline;"
              onsubmit="return confirm('Are you sure you want to delete this invoice?');">
              <button type="submit" class="btn btn-sm btn-danger" style="margin-left: 5px;">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Email Draft</h2>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Subject</label>
        <input type="text" id="modalSubject" readonly>
      </div>
      <div class="form-group">
        <label>Body</label>
        <textarea id="modalBody" readonly></textarea>
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-secondary" onclick="closeEmailModal()">Close</button>
      <button class="btn btn-primary" onclick="copyToClipboard()">Copy Body</button>
    </div>
  </div>
</div>

<!-- Paid Date Modal -->
<div id="paidModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Mark as Paid</h2>
    </div>
    <form id="paidForm" method="post">
      <div class="modal-body">
        <div class="form-group">
          <label>Paid Date</label>
          <input type="date" name="paid_date" id="paidDateInput" required>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closePaidModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Confirm</button>
      </div>
    </form>
  </div>
</div>

<script>
  const modal = document.getElementById('emailModal');
  const paidModal = document.getElementById('paidModal');
  const subjectInput = document.getElementById('modalSubject');
  const bodyInput = document.getElementById('modalBody');
  const paidDateInput = document.getElementById('paidDateInput');
  const paidForm = document.getElementById('paidForm');

  function openEmailModal(btn) {
    subjectInput.value = btn.dataset.subject;
    bodyInput.value = btn.dataset.body;
    modal.classList.add('show');
  }

  function closeEmailModal() {
    modal.classList.remove('show');
  }

  function openPaidModal(btn) {
    const invoiceId = btn.dataset.id;
    console.log("Opening paid modal for invoice:", invoiceId);
    // Set form action
    paidForm.action = "/invoices/" + invoiceId + "/toggle-status";
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    paidDateInput.value = today;
    paidModal.classList.add('show');
  }

  function closePaidModal() {
    paidModal.classList.remove('show');
  }

  function copyToClipboard() {
    bodyInput.select();
    document.execCommand('copy');
    alert('Email body copied to clipboard!');
  }

  // Close modal when clicking outside
  window.onclick = function (event) {
    if (event.target == modal) {
      modal.classList.remove('show');
    }
    if (event.target == paidModal) {
      paidModal.classList.remove('show');
    }
  }
</script>
{% endblock %}